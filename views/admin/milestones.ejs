<%- include('../partials/header') %>

<style>
  .tabs {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
  }
  .tab-link {
    padding: 1rem 1.5rem;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--text-secondary);
    font-size: 1.1rem;
    position: relative;
    top: 2px;
  }
  .tab-link.active {
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .timeline {
    list-style: none;
    padding: 0;
  }
  .timeline-item {
    display: flex;
    gap: 1.5rem;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-color);
  }
  .timeline-date {
    flex-basis: 120px;
    text-align: right;
    color: var(--text-secondary);
  }
  .timeline-body {
    flex-grow: 1;
  }
</style>

<div class="container container-lg watercolor-rose" style="margin-top: 3rem; margin-bottom: 4rem;">
  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;"><%= t('admin.milestones.manage') %></h1>
      <p style="color: var(--text-secondary); margin: 0;">
        <%= t('admin.milestones.manage.copy') %>
      </p>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-link active" onclick="openTab(event, 'byCategory')">By Category</button>
    <button class="tab-link" onclick="openTab(event, 'timeline')">Timeline</button>
  </div>

  <div id="byCategory" class="tab-content active">
    <!-- Search and Filter Form -->
    <div class="card" style="margin-bottom: 2rem;">
      <form method="GET" action="/admin/milestones">
        <div class="grid grid-2">
          <div class="form-group">
            <label for="search" class="form-label"><%= t('admin.participants.search.placeholder') %></label>
            <input type="text" id="search" name="search" class="form-input" placeholder="<%= t('admin.participants.search.placeholder') %>" value="<%= search %>" />
          </div>
          <div class="form-group">
            <label for="filter_milestone" class="form-label"><%= t('admin.milestones.filter') || 'Filter by Milestone' %></label>
            <select id="filter_milestone" name="filter_milestone" class="form-select">
              <option value=""><%= t('admin.participants.filter.all') || 'All Participants' %></option>
              <% milestoneCategories.forEach(cat => { %>
                <option value="<%= cat.milestone_category %>" <%= filter_milestone == cat.milestone_category ? 'selected' : '' %>>
                  <%= t('admin.milestones.has') || 'Has' %> <%= cat.milestone_category %>
                </option>
              <% }) %>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" class="btn btn-primary"><%= t('admin.surveys.apply') %></button>
          <a href="/admin/milestones" class="btn btn-outline"><%= t('admin.surveys.clear') %></a>
        </div>
      </form>
    </div>

    <% if (paginatedUsers && paginatedUsers.length > 0) { %>
      <div style="overflow-x: auto;">
        <table class="table" style="min-width: 1200px;">
          <thead>
            <tr>
              <th style="position: sticky; left: 0; background-color: var(--bg-primary); z-index: 10;"><%= t('admin.milestones.table.participant') %></th>
              <% milestoneCategories.forEach(category => { %>
                <th style="text-align: center; min-width: 100px; font-size: 0.85rem;"><%= category.milestone_category %></th>
              <% }) %>
            </tr>
          </thead>
          <tbody>
            <% paginatedUsers.forEach(user => { %>
              <tr>
                <td style="position: sticky; left: 0; background-color: var(--bg-primary); z-index: 5;">
                  <a href="/admin/participants/<%= user.id %>" style="text-decoration: none; color: inherit;">
                    <strong><%= user.participant_first_name %> <%= user.participant_last_name %></strong>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);"><%= user.participant_email %></div>
                  </a>
                </td>
                <% milestoneCategories.forEach(category => { %>
                  <td style="text-align: center;">
                    <% const achievements = userAchievements[user.id] ? Object.values(userAchievements[user.id]).flat().filter(m => m.milestone_category === category.milestone_category) : [] %>
                    <% if (achievements.length > 0) { %>
                      <span style="color: #10b981; font-size: 1.5rem;" title="Completed">‚úì</span>
                      <% if (achievements.length > 1) { %><span style="font-size: 0.75rem; color: var(--text-secondary);">(<%= achievements.length %>)</span><% } %>
                    <% } else { %>
                      <span style="color: var(--text-light); font-size: 1.5rem;">‚óã</span>
                    <% } %>
                  </td>
                <% }) %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <!-- Pagination etc. -->
    <% } else { %>
        <p>No participants found.</p>
    <% } %>
  </div>

  <div id="timeline" class="tab-content">
    <ul class="timeline">
      <% participantMilestones.sort((a,b) => new Date(b.milestone_date) - new Date(a.milestone_date)).forEach(milestone => { %>
        <li class="timeline-item">
          <div class="timeline-icon">üèÜ</div>
          <div class="timeline-body">
            <p style="margin: 0; font-weight: 600;">
              <a href="/admin/participants/<%= milestone.participant_id %>" style="color: var(--primary-color);"><%= milestone.user_name %></a>
              achieved a milestone.
            </p>
            <p style="margin: 0.25rem 0; font-size: 1.1rem;"><%= milestone.milestone_title %></p>
            <p style="margin: 0; color: var(--text-secondary);"><%= milestone.milestone_category %> | <%= new Date(milestone.milestone_date).toLocaleDateString() %></p>
          </div>
        </li>
      <% }) %>
    </ul>
  </div>

</div>

<script>
  function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
  }
</script>

<%- include('../partials/footer') %>
